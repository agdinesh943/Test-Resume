<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Preview</title>
    <link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon/favicon-16x16.png">
    <link rel="manifest" href="./favicon/site.webmanifest">
    <link rel="stylesheet" href="index.css">
    <style>
        /* High-quality PDF rendering - match backend template exactly */
        * {
            -webkit-print-color-adjust: exact !important;
            color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* Ensure crisp rendering */
        img {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        /* A4 specific adjustments - fill entire page with no gaps */
        .resume-container {
            width: 210mm !important;
            min-height: 297mm !important;
            margin: 0 auto !important;
            padding: 0 6mm !important;
            background: white !important;
            box-shadow: none !important;
            position: relative !important;
            overflow: visible !important;
            box-sizing: border-box !important;
            max-width: 90vw !important;
        }

        /* Ensure body centers the content properly */
        body {
            font-family: 'Times New Roman', Times, serif !important;
            background-color: #f5f5f5 !important;
            padding: 20px !important;
            margin: 0 !important;
            width: 100% !important;
            min-height: 100vh !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            box-sizing: border-box !important;
            text-align: left !important;
        }

        /* Ensure html provides proper centering */
        html {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            height: 100% !important;
            box-sizing: border-box !important;
        }

        /* Position footer at bottom of page with small gap */
        .footer {
            position: absolute !important;
            bottom: 2mm !important;
            left: 6mm !important;
            right: 6mm !important;
            margin: 0 !important;
            padding: 0 !important;
            z-index: 10 !important;
        }

        .footer .footer-bold {
            font-weight: 900 !important;
        }

        /* Position top logos at top of page with small gap */
        .header-container {
            margin-top: 0mm !important;
            padding-top: 0 !important;
            position: relative !important;
            z-index: 1000 !important;
            overflow-y: hidden;

        }

        /* Logo styling for PDF */
        .logo-au {
            width: 650px !important;
            height: 90px !important;
            margin-left: 10px !important;
            object-fit: contain !important;
        }

        .logo-container {
            height: 80px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: flex-end !important;
            gap: 8px !important;
            flex-wrap: nowrap !important;
            overflow: hidden !important;
            /* margin-left: auto !important; */
            width: 100% !important;
        }

        .hackerrank-logo,
        .leetcode-logo {
            width: 90px !important;
            height: 50px !important;
            object-fit: contain !important;
            vertical-align: middle !important;
            margin-bottom: 20px !important;
            flex-shrink: 0 !important;
        }

        /* Ensure main content doesn't overlap with footer */
        .main-content {
            margin-bottom: 15mm !important;
            padding-bottom: 0 !important;
        }

        /* Ensure body fills entire page */
        body {
            font-family: 'Times New Roman', Times, serif !important;
            background-color: white !important;
            padding: 0 !important;
            margin: 0 !important;
            width: 100% !important;
            min-height: 297mm !important;
            margin: 0 auto !important;
        }

        /* Ensure html fills entire page */
        html {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            height: 297mm !important;
        }

        /* Ensure images load properly */
        img {
            max-width: 100% !important;
            height: auto !important;
        }

        /* Download button container */
        .download-container {
            margin-bottom: 20px !important;
            text-align: center !important;
            width: 100% !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
        }

        .download-btn {
            background: #007bff !important;
            color: white !important;
            border: none !important;
            padding: 12px 24px !important;
            border-radius: 6px !important;
            font-size: 16px !important;
            cursor: pointer !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            transition: background-color 0.3s !important;
        }

        .download-btn:hover {
            background: #0056b3 !important;
        }

        .download-btn:disabled {
            background: #6c757d !important;
            cursor: not-allowed !important;
        }

        /* Resume wrapper for centering */
        .resume-wrapper {
            width: 100% !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            flex: 1 !important;
        }

        /* Resume container with border - override previous styles */
        .resume-container {
            border: 2px solid #ddd !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
            background: white !important;
            width: 210mm !important;
            max-width: 90vw !important;
            margin: 0 auto !important;
            display: block !important;
            position: relative !important;
            text-align: left !important;
        }

        /* Ensure all text elements are left-aligned */
        .resume-container * {
            text-align: justify !important;
        }

        .student-name {
            text-align: center !important;
        }

        /* Center only the footer text */
        .resume-container .footer {
            text-align: center !important;
        }

        .resume-container .footer * {
            text-align: center !important;
        }

        /* Back button styling */
        .back-button {
            position: fixed !important;
            top: 20px !important;
            left: 20px !important;
            z-index: 1000 !important;
            background: #007bff !important;
            color: white !important;
            border: none !important;
            border-radius: 50% !important;
            width: 50px !important;
            height: 50px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
            transition: all 0.3s ease !important;
            font-size: 20px !important;
        }

        .back-button:hover {
            background: #0056b3 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3) !important;
        }

        .back-button:active {
            transform: translateY(0) !important;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</head>

<body>
    <!-- Back button -->
    <!-- <button id="backBtn" class="back-button" title="Back to Form">
        <ion-icon name="arrow-back"></ion-icon>
    </button> -->

    <div class="download-container">
        <button id="downloadBtn" class="download-btn"><ion-icon name="document-text"></ion-icon> Download PDF</button>
    </div>
    <div class="resume-wrapper" id="resumeWrapper">
        <!-- Resume content will be loaded here -->
    </div>
    <script>
        // Load resume data from sessionStorage
        let resumeData = null;
        let formData = null;
        let uploadedImages = null;
        let selectedLogos = null;
        let resumeHTML = null;

        // Load data when page loads
        window.addEventListener('DOMContentLoaded', function () {
            try {
                const storedData = sessionStorage.getItem('resumeData');
                if (!storedData) {
                    alert('No resume data found. Please fill out the form first.');
                    window.location.href = '/resume-form';
                    return;
                }

                resumeData = JSON.parse(storedData);
                formData = resumeData.formData;
                uploadedImages = resumeData.uploadedImages;
                selectedLogos = resumeData.selectedLogos;
                resumeHTML = resumeData.resumeHTML;

                // Update page title
                document.title = `Resume - ${formData.studentName}`;

                // Load resume HTML
                document.getElementById('resumeWrapper').innerHTML = resumeHTML;

                // Setup download button
                setupDownloadButton();

                // Setup back button
                // setupBackButton();


            } catch (error) {
                console.error('Error loading resume data:', error);
                alert('Error loading resume data. Please try again.');
                window.location.href = '/resume-form';
            }
        });

        function setupDownloadButton() {
            document.getElementById('downloadBtn').addEventListener('click', async function () {
                const element = document.getElementById('resume-content');
                const username = formData.studentName.replace(/\s+/g, '_');

                try {
                    // Show loading state
                    this.textContent = 'Generating PDF...';
                    this.disabled = true;

                    // Send to backend for high-quality PDF generation
                    // Use production URL if not on localhost, otherwise use localhost
                    const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
                    const apiUrl = isProduction
                        ? 'https://resume-maker-3-4n85.onrender.com/generate-pdf'
                        : 'http://localhost:3000/generate-pdf';

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            html: element.innerHTML,
                            username: username
                        })
                    });

                    if (!response.ok) {
                        throw new Error('PDF generation failed');
                    }

                    // Get response as array buffer first
                    const arrayBuffer = await response.arrayBuffer();
                    console.log('PDF array buffer size:', arrayBuffer.byteLength);

                    // Check if response is valid
                    if (arrayBuffer.byteLength === 0) {
                        throw new Error('PDF response is empty');
                    }

                    // Check PDF header
                    const uint8Array = new Uint8Array(arrayBuffer);
                    const header = String.fromCharCode(...uint8Array.slice(0, 4));
                    console.log('PDF header:', header);

                    if (!header.startsWith('%PDF')) {
                        throw new Error('Invalid PDF format - not a PDF file');
                    }

                    // Create blob from array buffer
                    const blob = new Blob([arrayBuffer], { type: 'application/pdf' });
                    console.log('PDF blob size:', blob.size);
                    console.log('PDF blob type:', blob.type);

                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${username}_Resume.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                } catch (error) {
                    console.error('PDF generation error:', error);
                    alert('PDF generation failed. Please try again or use the browser print function.');
                } finally {
                    // Reset button state
                    this.textContent = 'Download PDF';
                    this.disabled = false;
                }
            });
        }

        // function setupBackButton() {
        //     document.getElementById('backBtn').addEventListener('click', function () {
        //         // Navigate back to the resume form
        //         window.location.href = '/resume-form';
        //     });
        // }
    </script>
</body>

</html>